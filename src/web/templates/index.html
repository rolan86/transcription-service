{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="transcription-app">
    <!-- Mode Selector -->
    <div class="mode-selector">
        <button class="mode-btn active" data-mode="upload">
            <span class="icon">&#128193;</span>
            Upload File
        </button>
        <button class="mode-btn" data-mode="url">
            <span class="icon">&#128279;</span>
            URL Import
        </button>
        <button class="mode-btn" data-mode="record">
            <span class="icon">&#127908;</span>
            Record Audio
        </button>
    </div>

    <!-- Quick Presets -->
    <div class="quick-presets">
        <span class="presets-label">Quick Settings:</span>
        <button class="preset-btn" data-preset="fast" title="Tiny model, no enhancements">Fast</button>
        <button class="preset-btn active" data-preset="balanced" title="Base model, auto language">Balanced</button>
        <button class="preset-btn" data-preset="accurate" title="Large model, speaker detection">Accurate</button>
    </div>

    <!-- Active Features Display -->
    <div class="active-features" id="active-features" hidden>
        <!-- Feature chips will be dynamically added here -->
    </div>

    <!-- Collapsible Settings Panels -->
    <div class="settings-accordion">
        <!-- Model & Language Panel -->
        <div class="accordion-panel" data-panel="model">
            <button class="accordion-header" type="button">
                <span class="accordion-title">Model & Language</span>
                <span class="accordion-summary" id="model-summary">Base, Auto-detect</span>
                <span class="accordion-icon">&#9662;</span>
            </button>
            <div class="accordion-content">
                <div class="accordion-grid">
                    <div class="setting-group">
                        <label for="model-select">Whisper Model</label>
                        <select id="model-select">
                            <option value="tiny">Tiny (Fastest, ~1GB VRAM)</option>
                            <option value="base" selected>Base (Balanced, ~1GB VRAM)</option>
                            <option value="small">Small (Better, ~2GB VRAM)</option>
                            <option value="medium">Medium (High Quality, ~5GB VRAM)</option>
                            <option value="large">Large (Best, ~10GB VRAM)</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label for="language-select">Audio Language</label>
                        <select id="language-select">
                            <option value="">Auto-detect</option>
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="it">Italian</option>
                            <option value="pt">Portuguese</option>
                            <option value="ja">Japanese</option>
                            <option value="ko">Korean</option>
                            <option value="zh">Chinese</option>
                            <option value="hi">Hindi</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhancements Panel -->
        <div class="accordion-panel" data-panel="enhancements">
            <button class="accordion-header" type="button">
                <span class="accordion-title">Enhancements</span>
                <span class="accordion-summary" id="enhancements-summary">None active</span>
                <span class="accordion-icon">&#9662;</span>
            </button>
            <div class="accordion-content">
                <div class="enhancement-options">
                    <label class="enhancement-option">
                        <input type="checkbox" id="enable-speakers">
                        <div class="enhancement-info">
                            <span class="enhancement-name">Speaker Detection</span>
                            <span class="enhancement-desc">Identify and label different speakers</span>
                        </div>
                        <span class="enhancement-status" id="speaker-status"></span>
                    </label>
                    <label class="enhancement-option">
                        <input type="checkbox" id="use-vocabulary">
                        <div class="enhancement-info">
                            <span class="enhancement-name">Custom Vocabulary</span>
                            <span class="enhancement-desc">Add domain-specific terms</span>
                        </div>
                        <button class="vocab-edit-btn" id="vocab-edit-btn" type="button" title="Edit Vocabulary">Edit</button>
                    </label>
                </div>
            </div>
        </div>

        <!-- Output Options Panel -->
        <div class="accordion-panel" data-panel="output">
            <button class="accordion-header" type="button">
                <span class="accordion-title">Output Options</span>
                <span class="accordion-summary" id="output-summary">JSON</span>
                <span class="accordion-icon">&#9662;</span>
            </button>
            <div class="accordion-content">
                <div class="accordion-grid">
                    <div class="setting-group">
                        <label for="format-select">Output Format</label>
                        <select id="format-select">
                            <option value="json" selected>JSON (Full data)</option>
                            <option value="txt">Plain Text</option>
                            <option value="srt">SRT Subtitles</option>
                            <option value="vtt">VTT Subtitles</option>
                        </select>
                    </div>
                </div>
                <div class="output-toggles">
                    <label class="toggle-option">
                        <input type="checkbox" id="show-timestamps">
                        <span>Show timestamps</span>
                    </label>
                    <label class="toggle-option">
                        <input type="checkbox" id="show-confidence">
                        <span>Highlight confidence</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Mode -->
    <div id="upload-mode" class="mode-content active">
        <div class="upload-zone" id="upload-zone">
            <div class="upload-icon">&#128194;</div>
            <p class="upload-text">Drag & drop audio/video file here</p>
            <p class="upload-subtext">or click to browse</p>
            <input type="file" id="file-input" accept=".mp3,.wav,.m4a,.flac,.mp4,.mov,.avi" hidden>
            <p class="supported-formats">Supported: MP3, WAV, M4A, FLAC, MP4, MOV, AVI</p>
        </div>
        <div class="file-info" id="file-info" hidden>
            <span class="file-name"></span>
            <button class="remove-file" id="remove-file">&times;</button>
        </div>
        <button class="transcribe-btn" id="transcribe-btn" disabled>
            Transcribe
        </button>
    </div>

    <!-- URL Mode -->
    <div id="url-mode" class="mode-content">
        <div class="url-input-container">
            <div class="url-input-group">
                <input type="text" id="url-input" class="url-input" placeholder="Paste YouTube or Vimeo URL here...">
                <button class="url-fetch-btn" id="url-fetch-btn">Fetch Info</button>
            </div>
            <p class="url-hint">Supported: YouTube (youtube.com, youtu.be) and Vimeo (vimeo.com)</p>
        </div>
        <div class="url-preview" id="url-preview" hidden>
            <div class="url-thumbnail" id="url-thumbnail"></div>
            <div class="url-info">
                <h4 class="url-title" id="url-title"></h4>
                <p class="url-meta">
                    <span id="url-uploader"></span>
                    <span id="url-duration"></span>
                </p>
            </div>
            <button class="url-clear-btn" id="url-clear-btn">&times;</button>
        </div>
        <button class="transcribe-btn" id="url-transcribe-btn" disabled>
            Transcribe from URL
        </button>
    </div>

    <!-- Record Mode -->
    <div id="record-mode" class="mode-content">
        <div class="record-controls">
            <button class="record-btn" id="record-btn">
                <span class="record-icon"></span>
                <span class="record-text">Start Recording</span>
            </button>
            <div class="record-timer" id="record-timer">00:00</div>
        </div>
        <div class="audio-level" id="audio-level">
            <div class="level-bar"></div>
        </div>
        <p class="record-hint">Click to start recording from your microphone</p>

        <!-- Recording Actions (shown after recording stops) -->
        <div class="recording-actions" id="recording-actions" hidden>
            <button class="action-btn" id="download-audio-btn">Download Audio</button>
            <button class="action-btn secondary" id="new-recording-btn">New Recording</button>
        </div>
    </div>

    <!-- Progress -->
    <div class="progress-container" id="progress-container" hidden>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <p class="progress-text" id="progress-text">Processing...</p>
    </div>

    <!-- Results -->
    <div class="results-container" id="results-container" hidden>
        <div class="results-header">
            <h2>Transcription Result</h2>
            <div class="results-meta">
                <span class="meta-item" id="result-language"></span>
                <span class="meta-item" id="result-confidence" title="Click for details"></span>
                <span class="meta-item" id="result-time"></span>
            </div>
            <button class="rename-speakers-btn" id="rename-speakers-btn" hidden>Rename Speakers</button>
        </div>

        <!-- Speaker Legend (shown when speakers are detected) -->
        <div class="speaker-legend" id="speaker-legend" hidden>
            <span class="legend-label">Speakers:</span>
            <div class="legend-items" id="legend-items"></div>
        </div>

        <div class="transcript-box" id="transcript-box">
            <pre id="transcript-text"></pre>
        </div>
        <div class="results-actions">
            <button class="action-btn" id="copy-btn">Copy Text</button>
            <div class="dropdown-container">
                <button class="action-btn" id="export-btn">Export ▾</button>
                <div class="dropdown-menu" id="export-menu" hidden>
                    <button class="dropdown-item" data-format="txt">Plain Text (.txt)</button>
                    <button class="dropdown-item" data-format="json">JSON (.json)</button>
                    <button class="dropdown-item" data-format="srt">SRT Subtitles (.srt)</button>
                    <button class="dropdown-item" data-format="vtt">VTT Subtitles (.vtt)</button>
                    <button class="dropdown-item" data-format="md">Markdown (.md)</button>
                </div>
            </div>
            <button class="action-btn" id="cleanup-btn">Clean Up</button>
            <div class="dropdown-container">
                <button class="action-btn" id="analyze-btn">Analyze ▾</button>
                <div class="dropdown-menu" id="analyze-menu" hidden>
                    <button class="dropdown-item" data-action="summary">Quick Summary</button>
                    <button class="dropdown-item" data-action="key-points">Key Points</button>
                    <button class="dropdown-item" data-action="action-items">Action Items</button>
                    <button class="dropdown-item" data-action="entities">Entities</button>
                    <button class="dropdown-item" data-action="meeting-notes">Meeting Notes</button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" data-action="full-analysis">Full Analysis</button>
                </div>
            </div>
            <button class="action-btn" id="translate-btn">Translate</button>
            <button class="action-btn secondary" id="new-transcription-btn">New Transcription</button>
        </div>

        <!-- Analysis Panel -->
        <div class="analysis-panel" id="analysis-panel" hidden>
            <div class="analysis-header">
                <h3>Analysis Results</h3>
                <div class="analysis-actions">
                    <button class="analysis-action-btn" id="copy-analysis-btn" title="Copy to clipboard">Copy</button>
                    <button class="analysis-action-btn" id="export-analysis-btn" title="Export as Markdown">Export</button>
                    <button class="analysis-close-btn" id="close-analysis-btn">&times;</button>
                </div>
            </div>
            <div class="analysis-progress" id="analysis-progress" hidden>
                <div class="progress-bar">
                    <div class="progress-fill" id="analysis-progress-fill"></div>
                </div>
                <p class="progress-text" id="analysis-progress-text">Analyzing...</p>
            </div>
            <div class="analysis-content" id="analysis-content">
                <!-- Analysis sections will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Live Transcript (for recording mode) -->
    <div class="live-transcript" id="live-transcript" hidden>
        <h3>Live Transcript</h3>
        <div class="live-text" id="live-text"></div>
    </div>

    <!-- Error Display -->
    <div class="error-container" id="error-container" hidden>
        <div class="error-message" id="error-message"></div>
        <button class="action-btn secondary" id="error-dismiss">Dismiss</button>
    </div>

    <!-- Filename Modal -->
    <div class="modal-overlay" id="filename-modal" hidden>
        <div class="modal-content">
            <h3 class="modal-title" id="modal-title">Save File</h3>
            <div class="modal-body">
                <label for="filename-input">File name:</label>
                <div class="filename-input-group">
                    <input type="text" id="filename-input" placeholder="Enter filename">
                    <span class="filename-extension" id="filename-extension">.txt</span>
                </div>
            </div>
            <div class="modal-actions">
                <button class="action-btn secondary" id="modal-cancel">Cancel</button>
                <button class="action-btn" id="modal-confirm">Download</button>
            </div>
        </div>
    </div>

    <!-- Speaker Rename Modal -->
    <div class="modal-overlay" id="speaker-modal" hidden>
        <div class="modal-content">
            <h3 class="modal-title">Rename Speakers</h3>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.875rem;">
                    Enter custom names for each speaker. Leave blank to keep original label.
                </p>
                <div class="speaker-rename-list" id="speaker-rename-list">
                    <!-- Speaker rename inputs will be dynamically added here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="action-btn secondary" id="speaker-modal-cancel">Cancel</button>
                <button class="action-btn" id="speaker-modal-confirm">Apply</button>
            </div>
        </div>
    </div>

    <!-- Vocabulary Modal -->
    <div class="modal-overlay" id="vocabulary-modal" hidden>
        <div class="modal-content modal-large">
            <h3 class="modal-title">Custom Vocabulary</h3>
            <div class="modal-body">
                <p style="margin-bottom: 12px; color: var(--text-muted); font-size: 0.875rem;">
                    Add domain-specific words, technical terms, or names to improve transcription accuracy.
                    Enter one term per line.
                </p>
                <textarea
                    id="vocabulary-textarea"
                    class="vocabulary-textarea"
                    placeholder="Enter custom vocabulary (one term per line)&#10;&#10;Examples:&#10;PyTorch&#10;Kubernetes&#10;Dr. Smith"
                    rows="10"
                ></textarea>
                <div class="vocab-count" id="vocab-count">0 terms</div>
            </div>
            <div class="modal-actions">
                <button class="action-btn secondary" id="vocab-modal-cancel">Cancel</button>
                <button class="action-btn" id="vocab-modal-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Translation Modal -->
    <div class="modal-overlay" id="translation-modal" hidden>
        <div class="modal-content modal-large">
            <h3 class="modal-title">Translate Transcript</h3>
            <div class="modal-body">
                <div class="translation-settings">
                    <div class="translation-lang-row">
                        <div class="translation-lang-group">
                            <label for="translate-from">From</label>
                            <select id="translate-from" class="translation-select">
                                <option value="en">English</option>
                            </select>
                        </div>
                        <span class="translation-arrow">&#8594;</span>
                        <div class="translation-lang-group">
                            <label for="translate-to">To</label>
                            <select id="translate-to" class="translation-select">
                                <option value="">Select language...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="translation-progress" id="translation-progress" hidden>
                    <div class="progress-bar">
                        <div class="progress-fill" id="translation-progress-fill"></div>
                    </div>
                    <p class="progress-text" id="translation-progress-text">Translating...</p>
                </div>
                <div class="translation-result" id="translation-result" hidden>
                    <label>Translated Text</label>
                    <div class="translation-output" id="translation-output"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="action-btn secondary" id="translation-modal-cancel">Cancel</button>
                <button class="action-btn" id="translation-modal-translate">Translate</button>
                <button class="action-btn" id="translation-modal-copy" hidden>Copy Translation</button>
            </div>
        </div>
    </div>

    <!-- AI Cleanup Modal -->
    <div class="modal-overlay" id="cleanup-modal" hidden>
        <div class="modal-content modal-large">
            <h3 class="modal-title">AI Transcript Cleanup</h3>
            <div class="modal-body">
                <p class="cleanup-description">
                    AI will remove filler words (um, uh, like), fix punctuation, and correct grammar while preserving the original meaning.
                </p>
                <div class="cleanup-provider-select">
                    <label for="cleanup-provider">AI Provider</label>
                    <select id="cleanup-provider" class="cleanup-select">
                        <option value="">Auto (use default)</option>
                    </select>
                    <span class="provider-status" id="provider-status"></span>
                </div>
                <div class="cleanup-progress" id="cleanup-progress" hidden>
                    <div class="progress-bar">
                        <div class="progress-fill" id="cleanup-progress-fill"></div>
                    </div>
                    <p class="progress-text" id="cleanup-progress-text">Processing...</p>
                </div>
                <div class="cleanup-result" id="cleanup-result" hidden>
                    <div class="cleanup-stats" id="cleanup-stats"></div>
                    <div class="cleanup-tabs">
                        <button class="cleanup-tab active" data-view="cleaned">Cleaned</button>
                        <button class="cleanup-tab" data-view="original">Original</button>
                        <button class="cleanup-tab" data-view="diff">Diff</button>
                    </div>
                    <div class="cleanup-output-container">
                        <div class="cleanup-output" id="cleanup-output-cleaned"></div>
                        <div class="cleanup-output" id="cleanup-output-original" hidden></div>
                        <div class="cleanup-output cleanup-diff" id="cleanup-output-diff" hidden></div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="action-btn secondary" id="cleanup-modal-cancel">Cancel</button>
                <button class="action-btn" id="cleanup-modal-run">Clean Up</button>
                <button class="action-btn" id="cleanup-modal-apply" hidden>Apply to Transcript</button>
                <button class="action-btn secondary" id="cleanup-modal-copy" hidden>Copy Cleaned</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/main.js"></script>
<script src="/static/js/uploader.js"></script>
<script src="/static/js/recorder.js"></script>
<script src="/static/js/websocket.js"></script>
{% endblock %}
